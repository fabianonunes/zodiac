define(["require","exports","module"],function(require,exports,module){(function(){function Tap(a,b){this.head=a,this.tail=b}function Chunk(a,b,c){this.root=a,this.next=b,this.data="",this.flushable=!1,this.taps=c}function Stream(){this.head=new Chunk(this)}function Stub(a){this.head=new Chunk(this),this.callback=a,this.out=""}function Stack(a,b,c,d){this.tail=b,this.isObject=!dust.isArray(a)&&a&&typeof a=="object",this.head=a,this.index=c,this.of=d}function Context(a,b,c){this.stack=a,this.global=b,this.blocks=c}var root=this,dust={};dust.cache={},typeof exports!="undefined"&&(module.exports=dust),typeof module!="undefined"&&module.exports?(module.exports=dust,dust.dust=dust):root.dust=dust,dust.register=function(a,b){!a||(dust.cache[a]=b)},dust.render=function(a,b,c){var d=(new Stub(c)).head;dust.load(a,d,Context.wrap(b)).end()},dust.stream=function(a,b){var c=new Stream;dust.nextTick(function(){dust.load(a,c.head,Context.wrap(b)).end()});return c},dust.renderSource=function(a,b,c){return dust.compileFn(a)(b,c)},dust.compileFn=function(a,b){var c=dust.loadSource(dust.compile(a,b));return function(a,b){var d=b?new Stub(b):new Stream;dust.nextTick(function(){c(d.head,Context.wrap(a)).end()});return d}},dust.load=function(a,b,c){var d=dust.cache[a];return d?d(b,c):dust.onLoad?b.map(function(b){dust.onLoad(a,function(d,e){if(d)return b.setError(d);dust.cache[a]||dust.loadSource(dust.compile(e,a)),dust.cache[a](b,c).end()})}):b.setError(new Error("Template Not Found: "+a))},dust.loadSource=function(source,path){return eval(source)},Array.isArray?dust.isArray=Array.isArray:dust.isArray=function(a){return Object.prototype.toString.call(a)=="[object Array]"},dust.nextTick=function(a){setTimeout(a,0)},dust.isEmpty=function(a){return dust.isArray(a)&&!a.length?!0:a===0?!1:!a},dust.filter=function(a,b,c){if(c)for(var d=0,e=c.length;d<e;d++){var f=c[d];f==="s"?b=null:a=dust.filters[f](a)}b&&(a=dust.filters[b](a));return a},dust.filters={h:function(a){return dust.escapeHtml(a)},j:function(a){return dust.escapeJs(a)},u:encodeURI,uc:encodeURIComponent},dust.makeBase=function(a){return new Context(new Stack,a)},Context.wrap=function(a){return a instanceof Context?a:new Context(new Stack(a))},Context.prototype.get=function(a){var b=this.stack,c;while(b){if(b.isObject){c=b.head[a];if(c!==undefined)return c}b=b.tail}return this.global?this.global[a]:undefined},Context.prototype.getPath=function(a,b){var c=this.stack,d=b.length;if(a&&d===0)return c.head;if(!c.isObject)return undefined;c=c.head;var e=0;while(c&&e<d)c=c[b[e]],e++;return c},Context.prototype.push=function(a,b,c){return new Context(new Stack(a,this.stack,b,c),this.global,this.blocks)},Context.prototype.rebase=function(a){return new Context(new Stack(a),this.global,this.blocks)},Context.prototype.current=function(){return this.stack.head},Context.prototype.getBlock=function(a){var b=this.blocks;if(!!b){var c=b.length,d;while(c--){d=b[c][a];if(d)return d}}},Context.prototype.shiftBlocks=function(a){var b=this.blocks;if(a){b?newBlocks=b.concat([a]):newBlocks=[a];return new Context(this.stack,this.global,newBlocks)}return this},Stub.prototype.flush=function(){var a=this.head;while(a){if(a.flushable)this.out+=a.data;else{if(a.error){this.callback(a.error),this.flush=function(){};return}return}a=a.next,this.head=a}this.callback(null,this.out)},Stream.prototype.flush=function(){var a=this.head;while(a){if(a.flushable)this.emit("data",a.data);else{if(a.error){this.emit("error",a.error),this.flush=function(){};return}return}a=a.next,this.head=a}this.emit("end")},Stream.prototype.emit=function(a,b){var c=this.events;c&&c[a]&&c[a](b)},Stream.prototype.on=function(a,b){this.events||(this.events={}),this.events[a]=b;return this},Chunk.prototype.write=function(a){var b=this.taps;b&&(a=b.go(a)),this.data+=a;return this},Chunk.prototype.end=function(a){a&&this.write(a),this.flushable=!0,this.root.flush();return this},Chunk.prototype.map=function(a){var b=new Chunk(this.root,this.next,this.taps),c=new Chunk(this.root,b,this.taps);this.next=c,this.flushable=!0,a(c);return b},Chunk.prototype.tap=function(a){var b=this.taps;b?this.taps=b.push(a):this.taps=new Tap(a);return this},Chunk.prototype.untap=function(){this.taps=this.taps.tail;return this},Chunk.prototype.render=function(a,b){return a(this,b)},Chunk.prototype.reference=function(a,b,c,d){if(typeof a=="function"){a=a(this,b,null,{auto:c,filters:d});if(a instanceof Chunk)return a}return dust.isEmpty(a)?this:this.write(dust.filter(a,c,d))},Chunk.prototype.section=function(a,b,c,d){if(typeof a=="function"){a=a(this,b,c,d);if(a instanceof Chunk)return a}var e=c.block,f=c["else"];d&&(b=b.push(d));if(dust.isArray(a)){if(e){var g=a.length,h=this;for(var i=0;i<g;i++)h=e(h,b.push(a[i],i,g));return h}}else if(a===!0){if(e)return e(this,b)}else if(a||a===0){if(e)return e(this,b.push(a))}else if(f)return f(this,b);return this},Chunk.prototype.exists=function(a,b,c){var d=c.block,e=c["else"];if(!dust.isEmpty(a)){if(d)return d(this,b)}else if(e)return e(this,b);return this},Chunk.prototype.notexists=function(a,b,c){var d=c.block,e=c["else"];if(dust.isEmpty(a)){if(d)return d(this,b)}else if(e)return e(this,b);return this},Chunk.prototype.block=function(a,b,c){var d=c.block;a&&(d=a);return d?d(this,b):this},Chunk.prototype.partial=function(a,b){return typeof a=="function"?this.capture(a,b,function(a,c){dust.load(a,c,b).end()}):dust.load(a,this,b)},Chunk.prototype.helper=function(a,b,c,d){return dust.helpers[a](this,b,c,d)},Chunk.prototype.capture=function(a,b,c){return this.map(function(d){var e=new Stub(function(a,b){a?d.setError(a):c(b,d)});a(e.head,b).end()})},Chunk.prototype.setError=function(a){this.error=a,this.root.flush();return this},dust.helpers={sep:function(a,b,c){return b.stack.index===b.stack.of-1?a:c.block(a,b)},idx:function(a,b,c){return c.block(a,b.push(b.stack.index))}},Tap.prototype.push=function(a){return new Tap(a,this)},Tap.prototype.go=function(a){var b=this;while(b)a=b.head(a),b=b.tail;return a};var HCHARS=new RegExp(/[&<>\"]/),AMP=/&/g,LT=/</g,GT=/>/g,QUOT=/\"/g;dust.escapeHtml=function(a){if(typeof a=="string")return HCHARS.test(a)?a.replace(AMP,"&amp;").replace(LT,"&lt;").replace(GT,"&gt;").replace(QUOT,"&quot;"):a;return a};var BS=/\\/g,CR=/\r/g,LS=/\u2028/g,PS=/\u2029/g,NL=/\n/g,LF=/\f/g,SQ=/'/g,DQ=/"/g,TB=/\t/g;dust.escapeJs=function(a){return typeof a=="string"?a.replace(BS,"\\\\").replace(DQ,'\\"').replace(SQ,"\\'").replace(CR,"\\r").replace(LS,"\\u2028").replace(PS,"\\u2029").replace(NL,"\\n").replace(LF,"\\f").replace(TB,"\\t"):a}})()})