function template(a,b,c){var d="";dust.stream("row-stream",{data:a,stream:b}).on("data",function(a){d+=a}).on("end",function(){c(d)})}function readFile(a,b,c){var d=new FileReaderSync,e=d.readAsText(a),f=[];e.split("\n").forEach(function(a){a=a.trim(),a&&(b?Array.prototype.push.apply(f,a.match(b)):f.push(a))}),c(f)}function sortBy(a,b,c){return a.sort(function(a,c){var d=a[b],e=c[b];return d<e?-1:d>e?1:0})}function define(a,b){var c=this,d=[];a.forEach(function(a){d.push(this[a])}),b.apply(c,d)}importScripts("../libs/underscore.min.js"),importScripts("../libs/dust.min.js"),importScripts("../templates.js");var icounter=0,TextWorker={sort:function(a){var b=[],c=dust.makeBase();a.forEach(function(a,c){if(!a)return;b.push({line:a})}),b=sortBy(b,"line"),template(b,function(a,b,d){var e=b.current();a.render(d.block,c.push({line:e.line}))},function(a){postMessage({t_counter:icounter++,html:a,length:b.length})})},uniq:function(a,b){var c={},d=dust.makeBase(),e;a.forEach(function(a,b){if(!a)return;c[a]=0}),e=Object.keys(c),template(e,function(a,b,c){a.render(c.block,d.push({line:b.current()}))},function(a){postMessage({t_counter:icounter++,html:a,length:e.length})})},difference:function(a,b){var c=[],d={},e=dust.makeBase();b.forEach(function(a,b){d[a]=!0}),template(a,function(a,b,f){var g=b.current();d[g]||(a.render(f.block,e.push({line:g})),c.push(g))},function(a){postMessage({t_counter:icounter++,html:a,lines:c,length:c.length})})},union:function(a,b){var c=b.concat(a),d=dust.makeBase();template(c,function(a,b,c){a.render(c.block,d.push({line:b.current()}))},function(a){postMessage({t_counter:icounter++,html:a,lines:c,length:c.length})})},intersection:function(a,b){var c=[],d={},e=dust.makeBase();a.forEach(function(a,b){d[a]=!0}),template(b,function(a,b,f){var g=b.current();d[g]===!0&&(d[g]=!1,a.render(f.block,e.push({line:g})),c.push(g))},function(a){postMessage({t_counter:icounter++,html:a,lines:c,length:c.length})})},symmetric:function(a,b){var c=[],d={},e=dust.makeBase();a.forEach(function(a){d[a]=+[d[a]]+1}),b.forEach(function(a){d[a]=+[d[a]]+1}),template(Object.keys(d),function(a,b,f){var g=b.current();d[g]===1&&(a.render(f.block,e.push({line:g})),c.push(g))},function(a){postMessage({t_counter:icounter++,html:a,lines:c,length:c.length})})},charge:function(a,b){postMessage({t_counter:icounter++,html:b.join("\n"),lines:b,length:b.length})},grep:function(a,b){var c=[],d={},e=dust.makeBase(),f=b.map(function(a){return new RegExp(a,"i")});template(a,function(a,b,d){var g,h;g=h=b.current();var i=f.some(function(a){return g!==(g=g.replace(a,"<b>$&</b>"))});i&&(a.render(d.block,e.push({line:g})),c.push(h))},function(a){postMessage({t_counter:icounter++,html:a,lines:c,length:c.length})})}};onmessage=function(a){var b=a.data,c=TextWorker[b.op];b.op==="sort"||b.op==="uniq"?c(b.lines,b.classes):b.op==="grep"?readFile(b.file,null,c.bind(TextWorker,b.previous)):readFile(b.file,b.mask,c.bind(TextWorker,b.previous))}