importScripts("libs/underscore-1.1.7.min.js");importScripts("libs/dust-core-0.3.0.min.js");
(function(){function b(e,a){return e.write("<span>").section(a.get("data"),a,{block:c},null).write("</span>")}function c(e,a){return e.section(a.get("stream"),a,{block:d},null)}function d(e,a){return e.exists(a.get("clazz"),a,{block:g},null).reference(a.get("line"),a,"h").write(" \n")}function g(e,a){return e.write('</span><span class="').reference(a.get("clazz"),a,"h").write('">')}dust.register("tmpl-row-stream",b);return b})();
var TextWorker={sort:function(b,c,d){var g=[],e=!1,a=dust.makeBase();b.forEach(function(a,f){a&&g.push({line:a,clazz:c[f]})});g=_.sortBy(g,function(a){return a.line});template(g,function(d,f,h){var i;f=f.current();i={line:f.line,clazz:f.clazz!==e&&(e=f.clazz)},f=i;d.render(h.block,a.push(f))},function(a){d({html:a,length:g.length});close()})},difference:function(b,c){var d=[],g=[],e={},a,i=dust.makeBase();c.forEach(function(a){e[a]=!0});template(b,function(f,h,b){h=h.current();if(!e[h]){var c={line:h,
clazz:!a&&(a="red")};f.render(b.block,i.push(c));d.push(h);g.push(a)}},function(a){postMessage({html:a,lines:d,length:d.length})})},union:function(b,c){var d=[],g=[],e=!1,a={},i=dust.makeBase();b.forEach(function(f){a[f]="red"});c.forEach(function(f){a[f]=[a[f]]+"blue"});template(Object.keys(a),function(f,h,b){var h=h.current(),c={line:h,clazz:a[h]!==e&&(e=a[h])};f.render(b.block,i.push(c));d.push(h);g.push(a[h])},function(a){postMessage({html:a,lines:d,length:d.length})})},intersection:function(b,
c){var d=[],g=[],e=!1,a={},i=dust.makeBase();b.forEach(function(f){a[f]=!0});template(c,function(f,b,c){b=b.current();if(a[b]){var j={line:b,clazz:!e&&(e="redblue")};f.render(c.block,i.push(j));d.push(b);g.push(e)}},function(a){postMessage({html:a,lines:d,length:d.length})})},symmetric:function(b,c){var d=[],g=[],e=!1,a={},i=dust.makeBase();b.forEach(function(b){a[b]=+[a[b]]+1});c.forEach(function(b){a[b]=+[a[b]]+1});template(Object.keys(a),function(b,c,k){c=c.current();if(a[c]==1){var j={line:c,
clazz:!e&&(e="redblue")};b.render(k.block,i.push(j));d.push(c);g.push(e)}},function(a){postMessage({html:a,lines:d,length:d.length})})},charge:function(b,c){postMessage({html:c.join("\n"),lines:c,length:c.length})}};onmessage=function(b){b=b.data;readFile(b.file,TextWorker[b.op].bind(TextWorker,b.previous))};function template(b,c,d){var g="";dust.stream("tmpl-row-stream",{data:b,stream:c}).on("data",function(b){g+=b}).on("end",function(){d(g)})}
function readFile(b,c){var d=new FileReader;d.onload=function(b){var d=[];b.target.result.split("\n").forEach(function(a){(a=a.trim())&&d.push(a)});c(d,b.target.result.trim())};d.onerror=postMessage;d.readAsText(b)};
