function sortBy(a,b,c){return a.sort(function(a,c){var d=a[b],e=c[b];return d<e?-1:d>e?1:0})}function readFile(a,b,c){var d=new FileReaderSync,e=d.readAsText(a),f=[];e.split("\n").forEach(function(a){b&&(a=b.exec(a)),a&&f.push(a.toString().trim())}),c(f)}function template(a,b,c){var d="";dust.stream("row-stream",{data:a,stream:b}).on("data",function(a){d+=a}).on("end",function(){c(d)})}function define(a,b){var c=this,d=[];a.forEach(function(a){d.push(this[a])}),b.apply(c,d)}importScripts("../libs/underscore.min.js"),importScripts("../libs/dust.min.js"),importScripts("../templates.js");var TextWorker={sort:function(a,b){var c=[],d={clazz:!1},e=dust.makeBase();b=b||[],a.forEach(function(a,d){!a||c.push({line:a,clazz:b[d]})}),c=sortBy(c,"line"),template(c,function(a,b,c){var f=b.current(),g={line:f.line,clazz:f.clazz!==d.clazz&&(d.clazz=f.clazz)};a.render(c.block,e.push(g))},function(a){postMessage({html:a,length:c.length})})},uniq:function(a,b){var c={},d={clazz:!1},e=dust.makeBase(),f=[];b=b||[],a.forEach(function(a,d){!a||(c[a]=b[d])}),template(Object.keys(c),function(a,b,g){var h=b.current(),i={line:h,clazz:c[h]!==d.clazz&&(d.clazz=c[h])};a.render(g.block,e.push(i)),f.push(h)},function(a){postMessage({html:a,lines:f,length:f.length})})},difference:function(a,b){var c=[],d=[],e={},f={},g=dust.makeBase();b.forEach(function(a,b){e[a]=!0}),template(a,function(a,b,h){var i=b.current();if(!e[i]){var j={line:i,clazz:!f.clazz&&(f.clazz="red")};a.render(h.block,g.push(j)),c.push(i),d.push(f.clazz)}},function(a){postMessage({html:a,lines:c,length:c.length})})},union:function(a,b){function h(a,b){return function(c){a[c]||(a[c]={qtd:0,clazz:""}),a[c].qtd++<2&&(a[c].clazz+=b)}}var c=[],d=[],e={clazz:!1},f={},g=dust.makeBase();a.forEach(h(f,"red")),b.forEach(h(f,"blue")),template(Object.keys(f),function(a,b,h){var i=b.current(),j=f[i].qtd,k={line:i,clazz:f[i].clazz!==e.clazz&&(e.clazz=f[i].clazz)};for(;j>0;j--)a.render(h.block,g.push(k)),c.push(i),d.push(f[i])},function(a){postMessage({html:a,lines:c,length:c.length})})},intersection:function(a,b){var c=[],d=[],e={clazz:!1},f={},g=dust.makeBase();a.forEach(function(a,b){f[a]=!0}),template(b,function(a,b,h){var i=b.current();if(f[i]){var j={line:i,clazz:!e.clazz&&(e.clazz="redblue")};a.render(h.block,g.push(j)),c.push(i),d.push(e.clazz)}},function(a){postMessage({html:a,lines:c,length:c.length})})},symmetric:function(a,b){var c=[],d=[],e={clazz:!1},f={},g=dust.makeBase();a.forEach(function(a){f[a]=+[f[a]]+1}),b.forEach(function(a){f[a]=+[f[a]]+1}),template(Object.keys(f),function(a,b,h){var i=b.current();if(f[i]===1){var j={line:i,clazz:!e.clazz&&(e.clazz="redblue")};a.render(h.block,g.push(j)),c.push(i),d.push(e.clazz)}},function(a){postMessage({html:a,lines:c,length:c.length})})},charge:function(a,b){postMessage({html:b.join("\n"),lines:b,length:b.length})},grep:function(a,b){var c=[],d=[],e={clazz:!1},f={},g=dust.makeBase(),h=b.map(function(a){return new RegExp(a,"i")});template(a,function(a,b,e){var i,j;i=j=b.current();var k=h.some(function(a){return i!==(i=i.replace(a,"<b>$&</b>"))});if(k){var l={line:i};a.render(e.block,g.push(l)),c.push(j),d.push(f[i])}},function(a){postMessage({html:a,lines:c,length:c.length})})}};onmessage=function(a){var b=a.data;b.op==="sort"||b.op==="uniq"?TextWorker[b.op](b.lines,b.classes):b.op==="grep"?readFile(b.file,null,TextWorker[b.op].bind(TextWorker,b.previous)):readFile(b.file,b.mask,TextWorker[b.op].bind(TextWorker,b.previous))}